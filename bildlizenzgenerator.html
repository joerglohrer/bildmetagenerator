<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TULLU(+B) Bildlizenzhinweis – Kopierfelder (Text · Figcaption · JSON-LD)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{background:#fff;color:#333}
  .container-narrow{max-width:980px}
  .card{border-radius:12px}
  .highlight-letter{font-weight:700;color:#002366}
  .author-row{display:grid;grid-template-columns:1.4fr 1fr auto;gap:.5rem}
  .output-area textarea{min-height:120px}
  .tullu-badges .badge{border-radius:999px}
  .figcaption-output a{color:#203A8F;text-decoration:none}
  .figcaption-output a:hover{color:#FFA500;text-decoration:underline}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div class="container container-narrow my-4">
  <h2 class="text-center mb-1">OER Bildlizenzhinweis (TULLU + B)</h2>
  <p class="text-center"><a href="https://www.orca.nrw/oer/oer-nutzen/tulluba-regel/" target="_blank">TULLUBA-Regel</a></p>

  <!-- Eingaben -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Eingaben</h5>

      <div class="mb-3">
        <label class="form-label" for="title"><span class="highlight-letter">T</span>itel</label>
        <input id="title" class="form-control" placeholder="z. B. Sonnenuntergang über Berlin">
      </div>

      <div class="mb-2">
        <label class="form-label"><span class="highlight-letter">U</span>rheber:in / Autor:in — mehrere möglich (optional mit URL)</label>
        <div id="authors" class="vstack gap-2"></div>
        <button id="addAuthorBtn" type="button" class="btn btn-outline-secondary btn-sm mt-2">+ Autor:in hinzufügen</button>
        <div class="form-text">Leere Zeilen werden ignoriert. Mit URL werden Namen verlinkt.</div>
      </div>

      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label"><span class="highlight-letter">L</span>izenz</label>
          <select id="license" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Lizenz-Version</label>
          <select id="licenseVersion" class="form-select">
            <option value="4.0" selected>4.0</option>
            <option value="3.0">3.0</option>
            <option value="2.0">2.0</option>
            <option value="1.0">1.0</option>
            <option value="">(keine/CC0/PDM)</option>
          </select>
        </div>
      </div>

      <div class="row g-2 mt-1">
        <div class="col-md-6">
          <label class="form-label"><span class="highlight-letter">L</span>ink zum Werk (Permalink)</label>
          <input id="workUrl" class="form-control" placeholder="https://…">
        </div>
        <div class="col-md-6">
          <label class="form-label"><span class="highlight-letter">U</span>rsprungsort / Plattform</label>
          <input id="source" class="form-control" placeholder="Wikimedia Commons, eigene Website …">
        </div>
      </div>

      <div class="row g-2 mt-1">
        <div class="col-md-3">
          <label class="form-label">Jahr (optional)</label>
          <input id="year" class="form-control" placeholder="2025" inputmode="numeric">
        </div>
        <div class="col-md-3">
          <label class="form-label">Sprache</label>
          <select id="lang" class="form-select">
            <option value="de" selected>Deutsch</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Zusätzliche Hinweise (optional)</label>
          <input id="extra" class="form-control" placeholder="z. B. Bildzuschnitt durch die Redaktion">
        </div>
      </div>

      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="isAdapted">
        <label class="form-check-label" for="isAdapted"><span class="highlight-letter">B</span>earbeitung/Anpassung vorhanden</label>
      </div>
      <textarea id="adaptationNote" class="form-control mt-2" placeholder="z. B. Zuschnitt, Farbkorrektur; Text hinzugefügt" disabled></textarea>

      <div class="mt-3 d-flex flex-wrap gap-2">
        <button id="buildBtn" type="button" class="btn btn-primary">Lizenzhinweis erzeugen</button>
        <button id="exampleBtn" type="button" class="btn btn-outline-secondary">Beispiel laden</button>
        <button id="resetBtn" type="button" class="btn btn-outline-secondary">Zurücksetzen</button>
      </div>

      <div class="form-text mt-2">
        Pflicht bei CC-BY/CC-BY-SA: Urheber:in, Lizenzname und -link. Bei Bearbeitungen immer kenntlich machen (+B).
      </div>
    </div>
  </div>

  <!-- TULLU-Badges -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">TULLU-Check</h5>
      <div class="tullu-badges" id="tulluBadges" aria-live="polite"></div>
    </div>
  </div>

  <!-- Kopierfelder -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">1) Klartext (für Impressum/Bildnachweis)</h5>
      <div class="output-area">
        <textarea id="outText" class="form-control" readonly></textarea>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title mb-2">2) HTML-Figcaption (kopieren) & Vorschau</h5>
      <div class="output-area mb-2">
        <textarea id="outFigcaption" class="form-control" readonly></textarea>
      </div>
      <figure class="text-center border rounded p-3">
        <img id="previewImage" src="#" alt="Vorschau-Bild" style="display:none;max-width:100%;margin-bottom:10px;">
        <figcaption id="figcaption-output" class="figcaption-output"></figcaption>
      </figure>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">3) JSON-LD (kopieren)</h5>
      <div class="output-area">
        <textarea id="outJsonLd" class="form-control" readonly></textarea>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Lizenzdatenbank ===== */
const LICENSES = [
  {id:"CC0", label:"CC0 (Public Domain Waiver)", url:()=>`https://creativecommons.org/publicdomain/zero/1.0/`, hasVersion:false},
  {id:"PDM", label:"Public Domain Mark (PDM)", url:()=>`https://creativecommons.org/publicdomain/mark/1.0/`, hasVersion:false},
  {id:"BY", label:"CC BY", url:v=>`https://creativecommons.org/licenses/by/${v||"4.0"}/`, hasVersion:true},
  {id:"BY-SA", label:"CC BY-SA", url:v=>`https://creativecommons.org/licenses/by-sa/${v||"4.0"}/`, hasVersion:true},
  {id:"BY-NC", label:"CC BY-NC", url:v=>`https://creativecommons.org/licenses/by-nc/${v||"4.0"}/`, hasVersion:true},
  {id:"BY-NC-SA", label:"CC BY-NC-SA", url:v=>`https://creativecommons.org/licenses/by-nc-sa/${v||"4.0"}/`, hasVersion:true},
  {id:"BY-ND", label:"CC BY-ND", url:v=>`https://creativecommons.org/licenses/by-nd/${v||"4.0"}/`, hasVersion:true},
  {id:"BY-NC-ND", label:"CC BY-NC-ND", url:v=>`https://creativecommons.org/licenses/by-nc-nd/${v||"4.0"}/`, hasVersion:true},
  {id:"CUSTOM", label:"Benutzerdefiniert (eigene Lizenz-URL später ergänzen)", url:()=>null, hasVersion:true}
];

/* ===== DOM helpers ===== */
const $  = sel => document.querySelector(sel);

/* ===== Populate Lizenz-Select ===== */
const licenseSel = $("#license");
LICENSES.forEach(l=>{ const o=document.createElement("option"); o.value=l.id; o.textContent=l.label; licenseSel.appendChild(o); });
licenseSel.value="BY";

/* ===== Autoren UI ===== */
const authorsWrap = $("#authors");
function addAuthor(name="", url=""){
  const row = document.createElement("div");
  row.className="author-row";
  row.innerHTML = `
    <input class="form-control" placeholder="Name (z. B. Maria Muster)" value="${escapeAttr(name)}">
    <input class="form-control" placeholder="https://autor.in/ (optional)" value="${escapeAttr(url)}">
    <button type="button" class="btn btn-outline-danger">✕</button>
  `;
  const [nameInput, urlInput, delBtn] = row.children;
  delBtn.addEventListener("click", ()=>row.remove());
  authorsWrap.appendChild(row);
}
function getAuthors(){
  return Array.from(authorsWrap.querySelectorAll(".author-row")).map(row=>{
    const [nameEl,urlEl] = row.children;
    const name=(nameEl.value||"").trim();
    const url=(urlEl.value||"").trim();
    return name ? { name, url } : null;
  }).filter(Boolean);
}
function clearAuthors(){ authorsWrap.innerHTML=""; }
function ensureAtLeastOneAuthor(){ if(!authorsWrap.querySelector(".author-row")) addAuthor(); }
$("#addAuthorBtn").addEventListener("click", ()=>addAuthor());
ensureAtLeastOneAuthor();

/* ===== Event wiring ===== */
$("#isAdapted").addEventListener("change", e=>{
  $("#adaptationNote").disabled = !e.target.checked;
  if(!e.target.checked) $("#adaptationNote").value="";
});

$("#license").addEventListener("change", ()=>{
  const def = LICENSES.find(l=>l.id===licenseSel.value);
  const lv = $("#licenseVersion");
  lv.disabled = def && def.hasVersion===false;
  if(lv.disabled) lv.value="";
});

$("#buildBtn").addEventListener("click", buildAll);
$("#exampleBtn").addEventListener("click", ()=>{
  $("#title").value="Sonnenuntergang über Berlin";
  clearAuthors();
  addAuthor("Maria Muster","https://beispiel.org/maria");
  addAuthor("Max Beispiel (Beispiel-Institut)","");
  $("#license").value="BY-SA";
  $("#licenseVersion").value="4.0";
  $("#workUrl").value="https://upload.wikimedia.org/wikipedia/commons/2/20/Sunset_example.jpg";
  $("#source").value="Wikimedia Commons";
  $("#year").value="2025";
  $("#isAdapted").checked=true;
  $("#adaptationNote").disabled=false;
  $("#adaptationNote").value="Zuschnitt; Farbkorrektur";
  $("#extra").value="Bildgröße reduziert";
  $("#lang").value="de";
  buildAll();
});
$("#resetBtn").addEventListener("click", ()=>{
  document.querySelectorAll("input, textarea").forEach(el=>{
    if(el.closest(".author-row")) return;
    if(el.type==="checkbox"){ el.checked=false; $("#adaptationNote").disabled=true; }
    else el.value="";
  });
  clearAuthors(); ensureAtLeastOneAuthor();
  $("#license").value="BY"; $("#licenseVersion").value="4.0"; $("#lang").value="de";
  $("#outText").value=""; $("#outFigcaption").value=""; $("#outJsonLd").value="";
  $("#figcaption-output").innerHTML=""; $("#previewImage").style.display="none";
  renderBadges({});
});

/* ===== Helpers ===== */
function escapeHTML(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function escapeAttr(s){return String(s).replace(/"/g,"&quot;");}

/* ===== Core: build all outputs ===== */
function readForm(){
  return {
    title: $("#title").value.trim(),
    creators: getAuthors(), // [{name,url?}]
    licenseId: $("#license").value,
    licenseVersion: $("#licenseVersion").value,
    workUrl: $("#workUrl").value.trim(),
    source: $("#source").value.trim(),
    year: $("#year").value.trim(),
    isAdapted: $("#isAdapted").checked,
    adaptationNote: $("#adaptationNote").value.trim(),
    extra: $("#extra").value.trim(),
    lang: $("#lang").value
  };
}

function formatAttribution(d){
  const licDef = LICENSES.find(l=>l.id===d.licenseId) || LICENSES[0];
  const licUrl = licDef.url(d.licenseVersion)||"";
  const licLabel = (d.licenseId==="CC0") ? "CC0 1.0"
    : (d.licenseId==="PDM") ? "Public Domain Mark 1.0"
    : (licDef.id==="CUSTOM") ? "Benutzerdefinierte Lizenz"
    : `${licDef.label} ${d.licenseVersion||""}`.trim();

  const isDE = d.lang==="de";
  const title = d.title || (isDE?"(ohne Titel)":"(untitled)");

  // Creators views
  const creatorsText = d.creators.length
    ? d.creators.map(c=> c.url ? `${c.name} (${c.url})` : c.name).join(", ")
    : (isDE?"(Urheber:in unbekannt)":"(creator unknown)");

  const creatorsHTML = d.creators.length
    ? d.creators.map(c=> c.url ? `<a href="${c.url}" target="_blank" rel="noopener">${escapeHTML(c.name)}</a>` : escapeHTML(c.name)).join(", ")
    : (isDE?"(Urheber:in unbekannt)":"(creator unknown)");

  // Klartext
  const parts = [];
  parts.push(`„${title}“`);
  parts.push(isDE?`von ${creatorsText}`:`by ${creatorsText}`);
  if(d.year) parts.push(d.year);
  parts.push( licDef.id==="CUSTOM"
    ? (isDE?`Lizenz: ${licLabel}`:`License: ${licLabel}`)
    : (isDE?`lizenziert unter ${licLabel}`:`licensed under ${licLabel}`) );
  if(d.source) parts.push(isDE?`Quelle: ${d.source}`:`Source: ${d.source}`);
  if(d.workUrl) parts.push((isDE?"Link: ":"Link: ")+d.workUrl);
  if(d.isAdapted){
    const note = d.adaptationNote || (isDE?"Bearbeitung vorhanden":"Adaptation present");
    parts.push(isDE?`Änderungen: ${note}`:`Changes: ${note}`);
  }
  if(d.extra) parts.push(d.extra);
  const textOut = parts.join(" · ");

  // Figcaption HTML-String (kompletter Block)
  const licHTML = licDef.id==="CUSTOM"
    ? escapeHTML(licLabel)
    : `<a href="${licUrl}" target="_blank" rel="license noopener">${escapeHTML(licLabel)}</a>`;

  const figcaptionInner = `
    Titel: „${escapeHTML(d.title||"")}”<br>
    Urheber:in: ${creatorsHTML}<br>
    Lizenz: ${licHTML}<br>
    Ursprungsort: ${ d.source ? escapeHTML(d.source) : "-" }<br>
    Link: ${ d.workUrl ? `<a href="${d.workUrl}" target="_blank" rel="noopener">${escapeHTML(d.workUrl)}</a>` : "-" }<br>
    ${ d.isAdapted ? `Änderungen: ${escapeHTML(d.adaptationNote||"Bearbeitung vorhanden")}<br>` : "" }
    ${ d.extra ? `${escapeHTML(d.extra)}<br>` : "" }
  `.trim().replace(/\n\s+/g,"");

  const figcaptionHTML = `<figcaption>${figcaptionInner}</figcaption>`;

  // JSON-LD
  const jsonLD = (()=>{
    const creators = d.creators.map(c=>({ "@type":"Person", "name":c.name, ...(c.url?{url:c.url}:{}) }));
    const licURL = licDef.id==="CUSTOM" ? "" : (licDef.url(d.licenseVersion)||"");
    const obj = {
      "@context":"https://schema.org",
      "@type":"ImageObject",
      "name": d.title || "",
      ...(d.workUrl?{"contentUrl": d.workUrl}:{ }),
      ...(d.source?{"isBasedOn": d.source}:{ }),
      ...(d.year?{"dateCreated": d.year}:{ }),
      "creator": creators,
      ...(licURL?{"license": licURL}:{ })
    };
    if(d.isAdapted) obj.creditText = `Adaptation: ${d.adaptationNote||"present"}`;
    if(d.extra) obj.comment = d.extra;
    return JSON.stringify(obj, null, 2);
  })();

  // TULLU checks
  const check = {
    T: !!d.title,
    U: d.creators.length>0,
    L: !!licLabel,
    L2: licDef.id==="CUSTOM" ? true : !!licUrl,
    U2: !!d.workUrl,
    U3: !!d.source,
    B:  d.isAdapted ? true : true
  };

  return { textOut, figcaptionHTML, figcaptionInner, jsonLD, check };
}

function renderBadges(check){
  const el = $("#tulluBadges");
  el.innerHTML="";
  [
    ["T","Titel"],["U","Urheber:in"],["L","Lizenz"],["L2","Lizenz-Link"],
    ["U2","Werk-Link"],["U3","Ursprungsort"],["B","+ B (Bearbeitung)"]
  ].forEach(([k,label])=>{
    const ok = !!check[k];
    const b = document.createElement("span");
    b.className = "badge me-1 " + (ok?"text-bg-success":"text-bg-warning");
    b.textContent = label + (ok?" ✓":" •");
    el.appendChild(b);
  });
}

function buildAll(){
  const d = readForm();
  const { textOut, figcaptionHTML, figcaptionInner, jsonLD, check } = formatAttribution(d);

  // Klartext
  $("#outText").value = textOut;

  // Figcaption (Kopierfeld + Preview)
  $("#outFigcaption").value = figcaptionHTML;
  $("#figcaption-output").innerHTML = figcaptionInner;
  if(d.workUrl){ $("#previewImage").src=d.workUrl; $("#previewImage").style.display="block"; }
  else { $("#previewImage").style.display="none"; }

  // JSON-LD
  $("#outJsonLd").value = jsonLD;

  renderBadges(check);
}

/* ===== Initial ===== */
function init(){ 
  document.getElementById("license").dispatchEvent(new Event("change"));
  buildAll();
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
